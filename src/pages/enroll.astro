---
import BaseLayout from "../layouts/BaseLayout.astro";
import { AIRPORT_CODE, AIRPORT_WITH_CODE_SHORT, CITY_AND_STATE, COMPANY_NAME, COMPANY_PRIMARY_SERVICE, EMAIL_ADDRESS, PHONE_NUMBER } from "../data/consts";
import HeroGeneralPages from "../components/HeroGeneralPages.astro";
import FinalCTASection from "../components/FinalCTASection.astro";
import MaintenancePhilosophy from "../components/Fleet/MaintenancePhilosophy.astro";

const ENROLLMENT_FORM_WEBHOOK_URL = import.meta.env.ENROLLMENT_FORM_WEBHOOK_URL;
const PORTAL_API_KEY = import.meta.env.PORTAL_API_KEY;
const CP_ACCOUNT_RANDOM_ID = import.meta.env.CP_ACCOUNT_RANDOM_ID;

// --- Dynamic Form Options ---
const programOptions = [
  "Zero to Airlines (Career Track)",
  "Private Pilot License",
  "Instrument Rating",
  "Commercial Pilot License",
  "Multi-Engine Rating",
  "CFI/CFII/MEI",
  "Just Exploring Options"
];

const startDateOptions = [
  "Immediately",
  "Within 1 Month",
  "1-3 Months",
  "3-6 Months",
  "6+ Months"
];

const experienceOptions = [
  "None (0 Hours)",
  "Student Pilot (Pre-Solo)",
  "Student Pilot (Soloed)",
  "Private Pilot",
  "Instrument Rated",
  "Commercial Pilot"
];

const financingOptions = [
  "Yes, I need financing",
  "Maybe, interested in learning more",
  "No, I will pay out of pocket",
  "Stratus Financial Pre-Approved"
];

const heroData = {
  images: [
    {
      src: "/src/assets/instructing/mh-aviation-instructing-on-top-of-plane.jpg",
      alt: "Enroll at MH Aviation",
      imageCentering: "object-center"
    }
  ],
  title: "Enroll With Us",
  subTitle: "Take the first step towards your pilot career. Complete the enrollment form below and our admissions team will contact you within 24 hours.",
};

const faqData = {
  upperheader: "Ready to Launch",
  title: "Enrollment FAQs",
  qnas: [
    {
      question: "What happens after I submit this form?",
      answer: "Our admissions team will review your application and contact you within 24 hours to schedule a consultation. We will discuss your aviation goals, financing options, and potential start dates."
    },
    {
      question: "Do I need to have my financing secured before applying?",
      answer: "No. You can apply today to start the conversation. Once accepted, we can guide you toward our financing partners, like Stratus Financial, to help secure your funding."
    },
    {
      question: "Is there an application fee?",
      answer: "No, there is no fee to submit this enrollment inquiry form. It is simply the first step in starting your conversation with our team."
    },
    {
      question: "Can I train part-time?",
      answer: "Yes! While we offer structured professional tracks, we also cater to part-time students who need flexibility. Just let us know your availability in the 'Additional Information' section."
    }
  ]
};

const finalCtaData = {
  eyebrow: "Not Ready to Apply?",
  headline: "Schedule a Visit First",
  bodyCopy: "If you'd prefer to see our facility and fleet before applying, book a discovery flight or tour.",
  cta: {
    text: "Contact Us",
    href: "/contact/",
    subtext: `Or call us at ${PHONE_NUMBER}`,
  },
  image: {
    src: "/src/assets/facilities/mh-aviation-facilities-front.jpg",
    alt: "MH Aviation Facility",
  },
};

const metaProps = {
  siteTitle: `Enroll in ${COMPANY_PRIMARY_SERVICE} in ${CITY_AND_STATE} | ${COMPANY_NAME}`,
  siteDescription: `Apply for professional pilot training at ${AIRPORT_WITH_CODE_SHORT}. Join our Zero to Airlines track or private pilot programs in ${CITY_AND_STATE}. Secure your future in the cockpit today.`,
  siteKeywords: `enroll in flight school, pilot training application ${CITY_AND_STATE}, learn to fly ${AIRPORT_CODE}, ${COMPANY_NAME} admission, professional pilot career`
};
---

<BaseLayout {...metaProps}>
  <HeroGeneralPages data={heroData} />

  <section class="py-20 md:py-28 bg-ink-50">
    <div class="max-w-7xl mx-auto px-5 md:px-8 lg:px-12">
      <div class="grid lg:grid-cols-12 gap-12 lg:gap-20">
        
        <div class="lg:col-span-8">
          <div class="bg-ink-50 p-8 md:p-12 rounded-sm shadow-xl border-t-4 border-ochre-600">
            <h2 class="text-3xl !font-main-header text-ink-950 uppercase tracking-wide mb-6">
              Enrollment Application
            </h2>
            <p class="text-lg text-ink-600 mb-10 leading-relaxed border-b border-ink-100 pb-8">
              Complete the form below to begin your enrollment process. Our admissions team will review your application and contact you within 24 hours.
            </p>

            <form id="enrollForm" class="space-y-8">
              <div class="hidden" aria-hidden="true">
                <label for="website">Website</label>
                <input type="text" id="website" name="website" tabindex="-1" autocomplete="off" />
              </div>

              <div class="bg-ink-50 p-8 rounded-sm border border-ink-100">
                <h3 class="font-main-header text-ink-950 text-xl uppercase tracking-wide mb-6 flex items-center gap-3">
                  <span class="w-8 h-8 rounded-full bg-ochre-600 text-ink-50 flex items-center justify-center text-sm font-bold">1</span>
                  Personal Information
                </h3>
                
                <div class="grid md:grid-cols-2 gap-6">
                  <div class="md:col-span-2">
                    <label for="name" class="block text-xs font-bold uppercase tracking-widest text-ink-500 mb-2">
                      Full Name <span class="text-ochre-600">*</span>
                    </label>
                    <input type="text" id="name" name="name" required class="w-full px-4 py-3 bg-ink-50 border border-ink-200 rounded-sm focus:ring-1 focus:ring-ochre-600 focus:border-ochre-600 outline-none transition-colors" placeholder="John Doe" />
                  </div>

                  <div>
                    <label for="email" class="block text-xs font-bold uppercase tracking-widest text-ink-500 mb-2">
                      Email Address <span class="text-ochre-600">*</span>
                    </label>
                    <input type="email" id="email" name="email" required class="w-full px-4 py-3 bg-ink-50 border border-ink-200 rounded-sm focus:ring-1 focus:ring-ochre-600 focus:border-ochre-600 outline-none transition-colors" placeholder="john@example.com" />
                  </div>

                  <div>
                    <label for="phone" class="block text-xs font-bold uppercase tracking-widest text-ink-500 mb-2">
                      Phone Number <span class="text-ochre-600">*</span>
                    </label>
                    <input type="tel" id="phone" name="phone" required class="w-full px-4 py-3 bg-ink-50 border border-ink-200 rounded-sm focus:ring-1 focus:ring-ochre-600 focus:border-ochre-600 outline-none transition-colors" placeholder="(555) 123-4567" />
                  </div>

                  <div class="md:col-span-2">
                    <label for="dob" class="block text-xs font-bold uppercase tracking-widest text-ink-500 mb-2">
                      Date of Birth <span class="text-ochre-600">*</span>
                    </label>
                    <input type="date" id="dob" name="dob" required class="w-full px-4 py-3 bg-ink-50 border border-ink-200 rounded-sm focus:ring-1 focus:ring-ochre-600 focus:border-ochre-600 outline-none transition-colors text-ink-600" />
                  </div>
                </div>
              </div>

              <div class="bg-ink-50 p-8 rounded-sm border border-ink-100">
                <h3 class="font-main-header text-ink-950 text-xl uppercase tracking-wide mb-6 flex items-center gap-3">
                  <span class="w-8 h-8 rounded-full bg-ochre-600 text-ink-50 flex items-center justify-center text-sm font-bold">2</span>
                  Aviation Goals
                </h3>

                <div class="space-y-6">
                  <div>
                    <label for="program" class="block text-xs font-bold uppercase tracking-widest text-ink-500 mb-2">
                      Program Interest <span class="text-ochre-600">*</span>
                    </label>
                    <select id="program" name="program" required class="w-full px-4 py-3 bg-ink-50 border border-ink-200 rounded-sm focus:ring-1 focus:ring-ochre-600 focus:border-ochre-600 outline-none transition-colors text-ink-900">
                      <option value="">Select a program...</option>
                      {programOptions.map(opt => <option value={opt}>{opt}</option>)}
                    </select>
                  </div>

                  <div class="grid md:grid-cols-2 gap-6">
                    <div>
                      <label for="startDate" class="block text-xs font-bold uppercase tracking-widest text-ink-500 mb-2">
                        Desired Start Date <span class="text-ochre-600">*</span>
                      </label>
                      <select id="startDate" name="startDate" required class="w-full px-4 py-3 bg-ink-50 border border-ink-200 rounded-sm focus:ring-1 focus:ring-ochre-600 focus:border-ochre-600 outline-none transition-colors text-ink-900">
                        <option value="">Select timeframe...</option>
                        {startDateOptions.map(opt => <option value={opt}>{opt}</option>)}
                      </select>
                    </div>

                    <div>
                      <label for="experience" class="block text-xs font-bold uppercase tracking-widest text-ink-500 mb-2">
                        Current Experience
                      </label>
                      <select id="experience" name="experience" class="w-full px-4 py-3 bg-ink-50 border border-ink-200 rounded-sm focus:ring-1 focus:ring-ochre-600 focus:border-ochre-600 outline-none transition-colors text-ink-900">
                        <option value="">Select level...</option>
                        {experienceOptions.map(opt => <option value={opt}>{opt}</option>)}
                      </select>
                    </div>
                  </div>

                  <div>
                    <label for="financing" class="block text-xs font-bold uppercase tracking-widest text-ink-500 mb-2">
                      Financing Needs <span class="text-ochre-600">*</span>
                    </label>
                    <select id="financing" name="financing" required class="w-full px-4 py-3 bg-ink-50 border border-ink-200 rounded-sm focus:ring-1 focus:ring-ochre-600 focus:border-ochre-600 outline-none transition-colors text-ink-900">
                      <option value="">Select option...</option>
                      {financingOptions.map(opt => <option value={opt}>{opt}</option>)}
                    </select>
                  </div>
                </div>
              </div>

              <div>
                <label for="message" class="block text-xs font-bold uppercase tracking-widest text-ink-500 mb-2">
                  Additional Information
                </label>
                <textarea id="message" name="message" rows="4" class="w-full px-4 py-3 bg-ink-50 border border-ink-200 rounded-sm focus:ring-1 focus:ring-ochre-600 focus:border-ochre-600 outline-none transition-colors text-ink-900 resize-none placeholder-ink-400" placeholder="Tell us about your career goals, availability, or any questions you have..."></textarea>
              </div>

              <div class="flex gap-x-4 items-start pt-4 border-t border-ink-100">
                <div class="flex h-6 items-center">
                  <button type="button" id="terms-toggle" class="bg-ink-200 flex w-11 flex-none cursor-pointer rounded-full p-px ring-1 ring-inset ring-ink-900/5 transition-colors duration-200 ease-in-out focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-ochre-600" role="switch" aria-checked="false">
                    <span class="sr-only">Agree to terms</span>
                    <span id="terms-thumb" class="translate-x-0 h-5 w-5 transform rounded-full bg-ink-50 shadow-sm ring-1 ring-ink-900/5 transition duration-200 ease-in-out" aria-hidden="true"></span>
                  </button>
                  <input type="hidden" id="agree-terms" name="agree-terms" value="no" />
                </div>
                <label class="text-sm leading-6 text-ink-600" id="switch-1-label">
                  I agree to the <a href="/privacy-policy/" class="font-bold text-ochre-600 hover:text-ochre-700 underline">Privacy Policy</a> and <a href="/terms-of-service/" class="font-bold text-ochre-600 hover:text-ochre-700 underline">Terms of Service</a>. By providing my phone number, I agree to receive text messages from MH Aviation regarding my application.
                </label>
              </div>

              <div>
                <button type="submit" id="submit-btn" disabled class="w-full bg-ink-300 cursor-not-allowed text-ink-50 px-8 py-4 rounded-sm font-bold uppercase tracking-widest text-sm transition-all shadow-lg flex items-center justify-center border border-transparent">
                  <span id="buttonText">Submit Application</span>
                  <svg id="buttonSpinner" class="hidden animate-spin ml-3 h-5 w-5 text-ink-50" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                </button>
              </div>

              <div id="successMessage" class="hidden bg-green-50 border-l-4 border-green-500 p-4 rounded-r-sm">
                <h3 class="text-green-800 font-bold text-sm uppercase tracking-wide">Application Submitted</h3>
                <p class="text-green-700 text-sm mt-1">Redirecting to confirmation page...</p>
              </div>

              <div id="errorMessage" class="hidden bg-red-50 border-l-4 border-red-500 p-4 rounded-r-sm">
                <h3 class="text-red-800 font-bold text-sm uppercase tracking-wide">Error</h3>
                <p class="text-red-700 text-sm mt-1" id="errorText">Something went wrong. Please try again.</p>
              </div>
            </form>
          </div>
        </div>

        <div class="lg:col-span-4 space-y-8">
          
          <div class="bg-ink-50 p-8 rounded-sm shadow-lg border border-ink-100">
            <h3 class="font-main-header text-ink-950 text-xl uppercase tracking-wide mb-6">What's Next?</h3>
            <ol class="relative border-l border-ink-200 ml-3 space-y-8">
              <li class="ml-6">
                <span class="absolute flex items-center justify-center w-6 h-6 bg-ochre-100 rounded-full -left-3 ring-4 ring-ink-50">
                  <span class="text-ochre-600 font-bold text-xs">1</span>
                </span>
                <h4 class="font-bold text-ink-900 text-sm uppercase tracking-wide mb-1">Application Review</h4>
                <p class="text-sm text-ink-600">Our admissions team reviews your goals and background.</p>
              </li>
              <li class="ml-6">
                <span class="absolute flex items-center justify-center w-6 h-6 bg-ochre-100 rounded-full -left-3 ring-4 ring-ink-50">
                  <span class="text-ochre-600 font-bold text-xs">2</span>
                </span>
                <h4 class="font-bold text-ink-900 text-sm uppercase tracking-wide mb-1">Consultation Call</h4>
                <p class="text-sm text-ink-600">We'll contact you within 24 hours to schedule a detailed chat.</p>
              </li>
              <li class="ml-6">
                <span class="absolute flex items-center justify-center w-6 h-6 bg-ochre-100 rounded-full -left-3 ring-4 ring-ink-50">
                  <span class="text-ochre-600 font-bold text-xs">3</span>
                </span>
                <h4 class="font-bold text-ink-900 text-sm uppercase tracking-wide mb-1">Facility Tour</h4>
                <p class="text-sm text-ink-600">Visit Fox Field, meet the team, and see our fleet.</p>
              </li>
              <li class="ml-6">
                <span class="absolute flex items-center justify-center w-6 h-6 bg-ochre-600 rounded-full -left-3 ring-4 ring-ink-50">
                  <svg class="w-3 h-3 text-ink-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                </span>
                <h4 class="font-bold text-ink-900 text-sm uppercase tracking-wide mb-1">Start Training</h4>
                <p class="text-sm text-ink-600">Finalize paperwork and schedule your first lesson.</p>
              </li>
            </ol>
          </div>
          <div class="bg-ink-950 text-ink-50 p-8 rounded-sm shadow-lg border-l-4 border-ochre-600">
            <h3 class="font-main-header text-xl uppercase tracking-wide mb-4">Questions?</h3>
            <p class="text-ink-200 text-sm mb-6">
              Our admissions team is here to help answer any questions about the enrollment process.
            </p>
            <div class="space-y-3">
              <a href={`tel:${PHONE_NUMBER}`} class="flex items-center text-ink-50 hover:text-ochre-400 transition-colors">
                <span class="bg-ochre-600 rounded-full p-1 mr-3 flex items-center justify-center">
                  <svg class="w-3 h-3 text-ink-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                </span>
                <span class="text-sm font-bold tracking-wide">{PHONE_NUMBER}</span>
              </a>
              <a href={`mailto:${EMAIL_ADDRESS}`} class="flex items-center text-ink-50 hover:text-ochre-400 transition-colors">
                <span class="bg-ochre-600 rounded-full p-1 mr-3 flex items-center justify-center">
                  <svg class="w-3 h-3 text-ink-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                </span>
                <span class="text-sm font-bold tracking-wide">{EMAIL_ADDRESS}</span>
              </a>
            </div>
          </div>

        </div>

      </div>
    </div>
  </section>
  <MaintenancePhilosophy/>
  <FinalCTASection data={finalCtaData} />
</BaseLayout>

<script define:vars={{ ENROLLMENT_FORM_WEBHOOK_URL, PORTAL_API_KEY, CP_ACCOUNT_RANDOM_ID }}>
  const form = document.getElementById("enrollForm");
  const successMessage = document.getElementById("successMessage");
  const errorMessage = document.getElementById("errorMessage");
  const errorText = document.getElementById("errorText");
  const buttonText = document.getElementById("buttonText");
  const buttonSpinner = document.getElementById("buttonSpinner");
  const submitButton = form?.querySelector('button[type="submit"]');

  const toggle = document.getElementById("terms-toggle");
  const thumb = document.getElementById("terms-thumb");
  const hiddenInput = document.getElementById("agree-terms");
  let isChecked = false;

  const SUBMIT_COOLDOWN = 30 * 1000;

  if (toggle && thumb && hiddenInput && submitButton) {
    toggle.addEventListener("click", () => {
      isChecked = !isChecked;
      hiddenInput.value = isChecked ? "yes" : "no";
      toggle.setAttribute("aria-checked", isChecked.toString());
      
      if (isChecked) {
        toggle.classList.remove("bg-ink-200");
        toggle.classList.add("bg-ochre-600");
        thumb.classList.remove("translate-x-0");
        thumb.classList.add("translate-x-5");
        
        submitButton.disabled = false;
        submitButton.classList.remove("bg-ink-300", "cursor-not-allowed");
        submitButton.classList.add("bg-ochre-600", "hover:bg-ochre-700", "cursor-pointer");
      } else {
        toggle.classList.add("bg-ink-200");
        toggle.classList.remove("bg-ochre-600");
        thumb.classList.add("translate-x-0");
        thumb.classList.remove("translate-x-5");
        
        submitButton.disabled = true;
        submitButton.classList.add("bg-ink-300", "cursor-not-allowed");
        submitButton.classList.remove("bg-ochre-600", "hover:bg-ochre-700", "cursor-pointer");
      }
    });
  }

  if (!form) {
    console.error("Form element not found.");
  } else {
    form.addEventListener("submit", async (event) => {
      event.preventDefault();

      if (!isChecked) {
        alert("Please agree to the Terms of Service to proceed.");
        return;
      }

      successMessage?.classList.add("hidden");
      errorMessage?.classList.add("hidden");

      const formData = new FormData(form);
      if (formData.get("website")?.trim()) {
         console.log("Bot detected");
         return;
      }
      formData.delete("website");

      const lastSubmit = parseInt(localStorage.getItem("lastEnrollSubmit") || "0", 10);
      const now = Date.now();
      if (now - lastSubmit < SUBMIT_COOLDOWN) {
        alert("Please wait a few seconds before submitting again.");
        return;
      }
      localStorage.setItem("lastEnrollSubmit", now.toString());

      if (submitButton) {
        submitButton.disabled = true;
        submitButton.classList.add("opacity-75", "cursor-wait");
      }
      if (buttonText) buttonText.textContent = "Submitting...";
      buttonSpinner?.classList.remove("hidden");

      const fullName = formData.get("name")?.toString() || "";
      const nameParts = fullName.split(" ");
      const firstName = nameParts[0] || "";
      const lastName = nameParts.slice(1).join(" ") || "";

      formData.append("timestamp", new Date().toISOString());
      formData.append("type", "enrollment");

      try {
        const [ghlRes, portalRes] = await Promise.all([
          fetch(ENROLLMENT_FORM_WEBHOOK_URL, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: new URLSearchParams(formData).toString(),
          }),
          fetch("https://portal.rightruddermarketing.com/api/leads", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
              "x-api-key": PORTAL_API_KEY,
            },
            body: JSON.stringify({
              first_name: firstName,
              last_name: lastName,
              email: formData.get("email")?.toString() || "",
              phone: formData.get("phone")?.toString() || "",
              campaign: "enrollment",
              account_random_id: CP_ACCOUNT_RANDOM_ID,
            }),
          }),
        ]);

        if (ghlRes.ok && portalRes.ok) {
           window.location.href = "/enroll-confirmation";
        } else {
           throw new Error("One or both requests failed");
        }
      } catch (err) {
        console.error("Submission error:", err);
        errorMessage?.classList.remove("hidden");
        if (errorText) errorText.textContent = "Something went wrong. Please try again or call us directly.";
        errorMessage?.scrollIntoView({ behavior: "smooth", block: "nearest" });
      } finally {
        if (isChecked && submitButton) {
            submitButton.disabled = false;
            submitButton.classList.remove("opacity-75", "cursor-wait");
        }
        if (buttonText) buttonText.textContent = "Submit Application";
        buttonSpinner?.classList.add("hidden");
      }
    });
  }
</script>