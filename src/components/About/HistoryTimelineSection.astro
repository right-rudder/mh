---
import ImageWithGradientAndText from "../ImageWithGradientAndText.astro";
import { FaChevronLeft, FaChevronRight } from "react-icons/fa";

interface Props {
  data: {
    eyebrow: string;
    title: string;
    steps: {
      year: string;
      title: string;
      description: string;
    }[];
    // Updated to accept an array of images
    images: {
      src: string;
      alt: string;
    }[];
  };
}

const { data } = Astro.props;
---

<section class="py-16 md:py-24 bg-ink-50 overflow-hidden">
  <div class="max-w-7xl mx-auto px-5 md:px-8 lg:px-12">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 lg:gap-20 items-start">
      
      <div class="order-2 lg:order-1 reveal-content opacity-0 -translate-x-8 transition-all duration-1000 ease-out">
        <span class="font-sans font-medium text-ochre-600 uppercase tracking-widest text-sm">
          {data.eyebrow}
        </span>
        <h2 class="title !text-[2.5rem] uppercase !font-main-header tracking-wide !text-ink-950 mb-10" set:html={data.title}></h2>
        <div class="space-y-10 relative border-l-2 border-ochre-200 ml-3 pl-8 md:pl-12">
          {data.steps.map((step) => (
            <div class="relative group cursor-default">
             <span class="absolute -left-[42px] md:-left-[58px] top-1 h-6 w-6 rounded-full bg-white border-4 border-ochre-600 shadow-sm 
             group-hover:scale-125 group-hover:border-ochre-700 group-hover:shadow-ochre-600/20 
             transition-all duration-300 z-10">
            </span>
              <div class="flex flex-col sm:flex-row sm:items-baseline gap-2 mb-2">
                <span class="text-3xl font-bold text-ochre-600 !font-main-header transition-colors duration-300">
                  {step.year}
                </span>
                <h3 class="text-xl font-bold text-ink-950 group-hover:text-ochre-600 transition-colors duration-300">
                  {step.title}
                </h3>
              </div>
              
              <p class="text-ink-600 group-hover:text-ink-950 leading-relaxed transition-colors duration-300">
                {step.description}
              </p>
            </div>
          ))}
        </div>
      </div>

      <div class="order-1 lg:order-2 relative h-[600px] w-full flex items-center justify-center reveal-image opacity-0 translate-x-8 transition-all duration-1000 ease-out">
        
        <div class="relative w-full h-full" id="history-carousel-container">
          {data.images.map((img, index) => (
            <div 
              class={`absolute inset-0 transition-all duration-700 ease-in-out transform rounded-sm shadow-2xl overflow-hidden history-carousel-item`}
              data-index={index}
              style={`z-index: ${data.images.length - index};`}
            >
              <ImageWithGradientAndText
                src={img.src}
                alt={img.alt}
                class="w-full h-full object-cover object-center"
              />
              <div class="absolute inset-0 bg-ink-950/10 pointer-events-none"></div>
            </div>
          ))}
        </div>

        <div class="absolute -bottom-6 flex gap-4 z-30">
          <button 
            id="history-prev-btn"
            class="w-24 h-12 rounded-l-full border border-ink-200 bg-ochre-600 text-ink-50 flex items-center justify-center hover:bg-ochre-500 hover:text-ink-100 hover:border-ochre-600 transition-all duration-300 shadow-md cursor-pointer"
            aria-label="Previous Image"
          >
            <FaChevronLeft />
          </button>
          <button 
            id="history-next-btn"
            class="w-24 h-12 rounded-r-full border border-ink-200 bg-ochre-600 text-ink-50 flex items-center justify-center hover:bg-ochre-500 hover:text-ink-100 hover:border-ochre-600 transition-all duration-300 shadow-md cursor-pointer"
            aria-label="Next Image"
          >
            <FaChevronRight />
          </button>
        </div>

      </div>

    </div>
  </div>
</section>

<style>
  .history-carousel-item {
    width: 90%; 
    height: 90%;
    top: 5%;
    left: 5%;
    opacity: 0;
    transform: scale(0.9) translateX(0) translateY(0) rotate(0deg);
    pointer-events: none;
  }

  .history-carousel-item.active {
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    opacity: 1;
    transform: scale(1) translateX(0) translateY(0) rotate(0deg);
    z-index: 20 !important;
    pointer-events: auto;
  }

  .history-carousel-item.prev {
    opacity: 0.7;
    transform: scale(0.96) translateX(-35px) translateY(15px) rotate(-5deg);
    z-index: 10 !important;
  }

  .history-carousel-item.next {
    opacity: 0.7;
    transform: scale(0.96) translateX(35px) translateY(15px) rotate(5deg);
    z-index: 9 !important;
  }
</style>

<script>
  const observerOptions = {
    threshold: 0.15,
  };

  const observer = new IntersectionObserver((entries) => {
    entries.forEach((entry) => {
      if (entry.isIntersecting) {
        entry.target.classList.remove('opacity-0', '-translate-x-8', 'translate-x-8');
        entry.target.classList.add('opacity-100', 'translate-x-0');
        observer.unobserve(entry.target);
      }
    });
  }, observerOptions);

  document.querySelectorAll('.reveal-image, .reveal-content').forEach((el) => observer.observe(el));

  // Slider Logic
  document.addEventListener('DOMContentLoaded', () => {
    const items = document.querySelectorAll('.history-carousel-item');
    const prevBtn = document.getElementById('history-prev-btn');
    const nextBtn = document.getElementById('history-next-btn');
    let currentIndex = 0;
    const totalItems = items.length;

    function updateCarousel() {
      items.forEach((item, index) => {
        item.classList.remove('active', 'prev', 'next');
        (item as HTMLElement).style.zIndex = '';

        if (index === currentIndex) {
          item.classList.add('active');
        } else if (index === (currentIndex - 1 + totalItems) % totalItems) {
          item.classList.add('prev');
        } else if (index === (currentIndex + 1) % totalItems) {
           item.classList.add('next');
        }
      });
    }

    if(totalItems > 0) {
      updateCarousel();

      nextBtn?.addEventListener('click', () => {
        currentIndex = (currentIndex + 1) % totalItems;
        updateCarousel();
      });

      prevBtn?.addEventListener('click', () => {
        currentIndex = (currentIndex - 1 + totalItems) % totalItems;
        updateCarousel();
      });
    }
  });
</script>